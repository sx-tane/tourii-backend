# Deployment Requirements - Digital Passport & Wallet Integration

## üéØ Overview

This document outlines all external dependencies, services, and configuration requirements needed to deploy the Digital Passport & Wallet Integration system to production.

## üìã External Service Requirements

### 1. Apple Developer Program (Required for Apple Wallet)

#### Account Setup
- **Cost**: $99 USD per year
- **Registration**: [developer.apple.com](https://developer.apple.com/programs/)
- **Processing Time**: 1-2 business days for approval
- **Requirements**: Valid Apple ID, business verification documents

#### Certificates and Identifiers
1. **Pass Type ID Creation**
   - Navigate to: Certificates, Identifiers & Profiles ‚Üí Identifiers ‚Üí Pass Type IDs
   - Create new Pass Type ID: `pass.com.tourii.passport`
   - Description: "Tourii Digital Passport"

2. **Certificate Generation**
   - Navigate to: Certificates, Identifiers & Profiles ‚Üí Certificates
   - Create new certificate: "Pass Type ID Certificate"
   - Select the Pass Type ID created above
   - Generate Certificate Signing Request (CSR) using Keychain Access
   - Download the certificate (.cer file)
   - Export as .p12 file with password protection

3. **Team ID Identification**
   - Found in: Account ‚Üí Membership
   - Format: 10-character alphanumeric string (e.g., "ABCDEF1234")

#### Required Assets
- **pass.json**: Automatically generated by implementation
- **icon.png**: 29x29 pixels, app icon
- **icon@2x.png**: 58x58 pixels, app icon (retina)
- **logo.png**: 160x50 pixels, strip logo
- **logo@2x.png**: 320x100 pixels, strip logo (retina)
- **strip.png**: 312x84 pixels, strip image
- **strip@2x.png**: 624x168 pixels, strip image (retina)

### 2. Google Pay Pass API (Required for Google Wallet)

#### Account Setup
- **Cost**: Free (no annual fee)
- **Registration**: [pay.google.com/business/console](https://pay.google.com/business/console)
- **Processing Time**: Immediate for basic setup, 1-3 days for issuer approval
- **Requirements**: Google account, business verification for production

#### Service Account Setup
1. **Google Cloud Console**
   - Create new project or use existing
   - Enable Google Wallet API
   - Create service account with appropriate permissions

2. **Service Account Key**
   - Generate private key (.json file)
   - Download and store securely
   - This file contains sensitive credentials

3. **Issuer Registration**
   - Register as a Google Pay Pass issuer
   - Obtain Issuer ID (format: `12345678901234567890`)
   - Create pass class in Google Wallet Console

#### Required Configuration
- **Class ID**: `tourii.tourii_passport`
- **Issuer ID**: Obtained from Google Wallet Console
- **Service Account**: JSON key file
- **Logo URLs**: Publicly accessible image URLs

### 3. Cloud Storage (Required for PDF Storage)

#### Cloudflare R2 (Current Implementation)
- **Account**: Cloudflare account with R2 enabled
- **Bucket**: Create bucket for passport PDFs
- **Access Keys**: R2 API tokens
- **CDN**: Optional CloudFlare CDN for faster delivery

#### Alternative: AWS S3
- **Account**: AWS account
- **Bucket**: S3 bucket with appropriate permissions
- **Access Keys**: IAM user with S3 permissions
- **CloudFront**: Optional CDN for faster delivery

### 4. Database (Current: PostgreSQL)
- **Version**: PostgreSQL 13+
- **Extensions**: Required Prisma extensions
- **Backup**: Automated backup solution
- **Monitoring**: Database performance monitoring

## üîß Environment Configuration

### Required Environment Variables

#### Apple Wallet Configuration
```bash
# Apple Developer Program
APPLE_TEAM_ID=ABCDEF1234
APPLE_PASS_TYPE_ID=pass.com.tourii.passport
APPLE_PASS_ORGANIZATION_NAME=Tourii Inc.

# Certificate Management
APPLE_PASS_CERT_PATH=/secure/certs/apple-pass.p12
APPLE_PASS_CERT_PASSWORD=your-certificate-password
APPLE_PASS_SIGNING_KEY=your-signing-key-here

# Pass Configuration
APPLE_PASS_DESCRIPTION=Tourii Digital Passport
APPLE_PASS_BACKGROUND_COLOR=rgb(255,255,255)
APPLE_PASS_FOREGROUND_COLOR=rgb(0,0,0)
APPLE_PASS_LABEL_COLOR=rgb(128,128,128)
```

#### Google Wallet Configuration
```bash
# Google Wallet API
GOOGLE_WALLET_ISSUER_ID=12345678901234567890
GOOGLE_WALLET_ISSUER_EMAIL=wallet@tourii.com
GOOGLE_WALLET_CLASS_ID=tourii.tourii_passport

# Service Account
GOOGLE_WALLET_KEY_PATH=/secure/keys/google-wallet-service-account.json
GOOGLE_WALLET_PRIVATE_KEY_ID=your-private-key-id
GOOGLE_WALLET_CLIENT_EMAIL=service-account@your-project.iam.gserviceaccount.com
GOOGLE_WALLET_CLIENT_ID=123456789012345678901

# Branding
GOOGLE_WALLET_LOGO_URL=https://cdn.tourii.com/logo.png
GOOGLE_WALLET_ICON_URL=https://cdn.tourii.com/icon.png
```

#### Storage Configuration
```bash
# Cloudflare R2
R2_ACCOUNT_ID=your-account-id
R2_ACCESS_KEY_ID=your-access-key
R2_SECRET_ACCESS_KEY=your-secret-key
R2_BUCKET_NAME=tourii-passports
R2_REGION=auto
R2_ENDPOINT=https://your-account-id.r2.cloudflarestorage.com

# Public URL Configuration
PASSPORT_PDF_BASE_URL=https://cdn.tourii.com/passports
```

#### Security Configuration
```bash
# JWT Signing
JWT_SECRET=your-super-secure-jwt-secret
QR_TOKEN_SIGNING_KEY=your-qr-token-signing-key

# HMAC Signing
WALLET_PASS_SIGNING_KEY=your-wallet-pass-signing-key
```

## üèóÔ∏è Infrastructure Requirements

### 1. Kubernetes Deployment

#### Secrets Management
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: wallet-integration-secrets
type: Opaque
data:
  apple-pass.p12: <base64-encoded-certificate>
  google-wallet-key.json: <base64-encoded-service-account>
  jwt-secret: <base64-encoded-jwt-secret>
stringData:
  APPLE_TEAM_ID: "ABCDEF1234"
  GOOGLE_WALLET_ISSUER_ID: "12345678901234567890"
```

#### ConfigMap
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: wallet-integration-config
data:
  APPLE_PASS_TYPE_ID: "pass.com.tourii.passport"
  APPLE_PASS_ORGANIZATION_NAME: "Tourii Inc."
  GOOGLE_WALLET_CLASS_ID: "tourii.tourii_passport"
  PASSPORT_PDF_BASE_URL: "https://cdn.tourii.com/passports"
```

#### Deployment Configuration
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tourii-backend
spec:
  template:
    spec:
      containers:
      - name: backend
        image: tourii/backend:latest
        envFrom:
        - configMapRef:
            name: wallet-integration-config
        - secretRef:
            name: wallet-integration-secrets
        volumeMounts:
        - name: certificates
          mountPath: /secure/certs
          readOnly: true
        - name: service-keys
          mountPath: /secure/keys
          readOnly: true
      volumes:
      - name: certificates
        secret:
          secretName: wallet-integration-secrets
          items:
          - key: apple-pass.p12
            path: apple-pass.p12
      - name: service-keys
        secret:
          secretName: wallet-integration-secrets
          items:
          - key: google-wallet-key.json
            path: google-wallet-service-account.json
```

### 2. Docker Configuration

#### Dockerfile Updates
```dockerfile
# Add certificate handling
RUN mkdir -p /secure/certs /secure/keys
COPY --from=certificates /certs/apple-pass.p12 /secure/certs/
COPY --from=service-keys /keys/google-wallet-key.json /secure/keys/

# Set proper permissions
RUN chmod 600 /secure/certs/* /secure/keys/*
```

#### Docker Compose
```yaml
version: '3.8'
services:
  backend:
    image: tourii/backend:latest
    environment:
      - APPLE_TEAM_ID=${APPLE_TEAM_ID}
      - GOOGLE_WALLET_ISSUER_ID=${GOOGLE_WALLET_ISSUER_ID}
    volumes:
      - ./certs:/secure/certs:ro
      - ./keys:/secure/keys:ro
    secrets:
      - apple-pass-cert
      - google-wallet-key
      - jwt-secret

secrets:
  apple-pass-cert:
    file: ./secrets/apple-pass.p12
  google-wallet-key:
    file: ./secrets/google-wallet-key.json
  jwt-secret:
    file: ./secrets/jwt-secret.txt
```

## üì¶ Dependency Management

### Package.json Additions
```json
{
  "dependencies": {
    "google-auth-library": "^8.9.0",
    "googleapis": "^126.0.1",
    "jszip": "^3.10.1"
  },
  "devDependencies": {
    "@types/jszip": "^3.4.1"
  }
}
```

### System Dependencies
```bash
# Required system packages
apt-get update && apt-get install -y \
  chromium-browser \
  fonts-liberation \
  libasound2 \
  libatk-bridge2.0-0 \
  libdrm2 \
  libxcomposite1 \
  libxdamage1 \
  libxrandr2 \
  libgbm1 \
  libxss1 \
  libnss3
```

## üîê Security Requirements

### Certificate Security
- Store certificates in secure key management system
- Implement certificate rotation mechanism
- Monitor certificate expiration dates
- Use hardware security modules (HSM) for high-security environments

### Network Security
- TLS 1.3 for all external communications
- VPN or private network for database connections
- API rate limiting and DDoS protection
- WAF (Web Application Firewall) for HTTP endpoints

### Data Protection
- Encrypt sensitive data at rest
- Implement data retention policies
- GDPR compliance for EU users
- Regular security audits and penetration testing

## üöÄ Deployment Checklist

### Pre-deployment Verification
- [ ] Apple Developer Program account active
- [ ] Google Wallet API enabled and configured
- [ ] All certificates and keys securely stored
- [ ] Environment variables properly set
- [ ] Database migrations completed
- [ ] Storage buckets created and configured
- [ ] CDN configured for asset delivery

### Deployment Steps
1. **Deploy Infrastructure**
   - Provision cloud resources
   - Configure security groups and firewalls
   - Set up monitoring and logging

2. **Deploy Application**
   - Build and push Docker images
   - Apply Kubernetes manifests
   - Verify pod startup and health checks

3. **Verify Functionality**
   - Test PDF generation endpoint
   - Test Apple Wallet pass generation
   - Test Google Wallet pass generation
   - Verify QR code scanning functionality

### Post-deployment Monitoring
- [ ] Application performance monitoring
- [ ] Error rate monitoring
- [ ] Certificate expiration alerts
- [ ] Storage usage monitoring
- [ ] API rate limit monitoring

## üìû Support Contacts

### Apple Developer Support
- **Developer Program Support**: [developer.apple.com/support](https://developer.apple.com/support)
- **Documentation**: [developer.apple.com/documentation/walletpasses](https://developer.apple.com/documentation/walletpasses)

### Google Wallet Support
- **API Support**: [developers.google.com/wallet/generic/web/support](https://developers.google.com/wallet/generic/web/support)
- **Documentation**: [developers.google.com/wallet](https://developers.google.com/wallet)

### Cloudflare R2 Support
- **Support Portal**: [support.cloudflare.com](https://support.cloudflare.com)
- **Documentation**: [developers.cloudflare.com/r2](https://developers.cloudflare.com/r2)

---

*Deployment Requirements: June 24, 2025*  
*Next Update: After production deployment*